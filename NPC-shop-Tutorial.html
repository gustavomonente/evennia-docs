<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>NPC shop Tutorial - Evennia Manual</title>
        <link href="css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">Evennia Manual</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="index.html">Home</a>
                            </li>
                            <li >
                                <a href="Administrative-Docs.html">Admin</a>
                            </li>
                            <li >
                                <a href="Builder-Docs.html">Building</a>
                            </li>
                            <li >
                                <a href="Developer-Central.html">Game Development</a>
                            </li>
                            <li >
                                <a href="Tutorials.html">Tutorials</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#the-shop-menu">The shop menu</a></li>
            <li><a href="#designing-the-menu">Designing the menu</a></li>
            <li><a href="#coding-the-menu">Coding the menu</a></li>
            <li><a href="#the-command-to-start-the-menu">The command to start the menu</a></li>
        <li class="main "><a href="#building-the-shop">Building the shop</a></li>
        <li class="main "><a href="#the-shop-is-open-for-business">The shop is open for business!</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p>This tutorial will describe how to make an NPC-run shop. We will make use of the <a href="EvMenu.html">EvMenu</a> system to present shoppers with a menu where they can buy things from the store's stock.</p>
<p>Our shop extends over two rooms - a "front" room open to the shop's customers and a locked "store room" holding the wares the shop should be able to sell. We aim for the following features:</p>
<ul>
<li>The front room should have an Attribute <code>storeroom</code> that points to the store room.</li>
<li>Inside the front room, the customer should have a command <code>buy</code> or <code>browse</code>. This will open a menu listing all items available to buy from the store room.</li>
<li>A customer should be able to look at individual items before buying.</li>
<li>We use "gold" as an example currency. To determine cost, the system will look for an Attribute <code>gold_value</code> on the items in the store room. If not found, a fixed base value of 1 will be assumed. The wealth of the customer should be set as an Attribute <code>gold</code> on the Character. If not set, they have no gold and can't buy anything.</li>
<li>When the customer makes a purchase, the system will check the <code>gold_value</code> of the goods and compare it to the <code>gold</code> Attribute of the customer. If enough gold is available, this will be deducted and the goods transferred from the store room to the inventory of the customer.</li>
<li>We will lock the store room so that only people with the right key can get in there.</li>
</ul>
<h3 id="the-shop-menu">The shop menu<a class="headerlink" href="#the-shop-menu" title="Permanent link">&para;</a></h3>
<p>We want to show a menu to the customer where they can list, examine and buy items in the store. This menu should change depending on what is currently for sale. Evennia's <em>EvMenu</em> utility will manage the menu for us. It's a good idea to <a href="EvMenu.html">read up on EvMenu</a> if you are not familiar with it.</p>
<h4 id="designing-the-menu">Designing the menu<a class="headerlink" href="#designing-the-menu" title="Permanent link">&para;</a></h4>
<p>The shopping menu's design is straightforward. First we want the main screen. You get this when you enter a shop and use the <code>browse</code> or <code>buy</code> command:</p>
<pre><code>*** Welcome to ye Old Sword shop! ***
   Things for sale (choose 1-3 to inspect, quit to exit):
_________________________________________________________
1. A rusty sword (5 gold)
2. A sword with a leather handle (10 gold)
3. Excalibur (100 gold)
</code></pre>

<p>There are only three items to buy in this example but the menu should expand to however many items are needed. When you make a selection you will get a new screen showing the options for that particular item:</p>
<pre><code>You inspect A rusty sword:

This is an old weapon maybe once used by soldiers in some
long forgotten army. It is rusty and in bad condition.
__________________________________________________________
1. Buy A rusty sword (5 gold)
2. Look for something else.
</code></pre>

<p>Finally, when you buy something, a brief message should pop up:</p>
<pre><code>You pay 5 gold and purchase A rusty sword!
</code></pre>

<p>or</p>
<pre><code>You cannot afford 5 gold for A rusty sword!
</code></pre>

<p>After this you should be back to the top level of the shopping menu again and can continue browsing.</p>
<h4 id="coding-the-menu">Coding the menu<a class="headerlink" href="#coding-the-menu" title="Permanent link">&para;</a></h4>
<p>EvMenu defines the <em>nodes</em> (each menu screen with options) as normal Python functions. Each node must be able to change on the fly depending on what items are currently for sale. EvMenu will automatically make the <code>quit</code> command available to us so we won't add that manually. For compactness we will put everything needed for our shop in one module, <code>mygame/typeclasses/npcshop.py</code>.</p>
<pre><code class="python"># mygame/typeclasses/npcshop.py

from evennia.utils import evmenu

def menunode_shopfront(caller):
    &quot;This is the top-menu screen.&quot;

    shopname = caller.location.key
    wares = caller.location.db.storeroom.contents

    # Wares includes all items inside the storeroom, including the
    # door! Let's remove that from our for sale list.
    wares = [ware for ware in wares if ware.key.lower() != &quot;door&quot;]

    text = &quot;*** Welcome to %s! ***\n&quot; % shopname
    if wares:
        text += &quot;   Things for sale (choose 1-%i to inspect);&quot; \
                &quot; quit to exit:&quot; % len(wares)
    else:
        text += &quot;   There is nothing for sale; quit to exit.&quot;

    options = []
    for ware in wares:
        # add an option for every ware in store
        options.append({&quot;desc&quot;: &quot;%s (%s gold)&quot; %
                             (ware.key, ware.db.gold_value or 1),
                        &quot;goto&quot;: &quot;menunode_inspect_and_buy&quot;})
    return text, options
</code></pre>

<p>In this code we assume the caller to be <em>inside</em> the shop when accessing the menu. This means we can access the shop room via <code>caller.location</code> and get its <code>key</code> to display as the shop's name. We also assume the shop has an Attribute <code>storeroom</code> we can use to get to our stock. We loop over our goods to build up the menu's options.</p>
<p>Note that <em>all options point to the same menu node</em> called <code>menunode_inspect_and_buy</code>! We can't know which goods will be available to sale so we rely on this node to modify itself depending on the circumstances. Let's create it now.</p>
<pre><code class="python"># further down in mygame/typeclasses/npcshop.py

def menunode_inspect_and_buy(caller, raw_string):
    &quot;Sets up the buy menu screen.&quot;

    wares = caller.location.db.storeroom.contents
    # Don't forget, we will need to remove that pesky door again!
    wares = [ware for ware in wares if ware.key.lower() != &quot;door&quot;]
    iware = int(raw_string) - 1
    ware = wares[iware]
    value = ware.db.gold_value or 1
    wealth = caller.db.gold or 0
    text = &quot;You inspect %s:\n\n%s&quot; % (ware.key, ware.db.desc)

    def buy_ware_result(caller):
        &quot;This will be executed first when choosing to buy.&quot;
        if wealth &gt;= value:
            rtext = &quot;You pay %i gold and purchase %s!&quot; % \
                         (value, ware.key)
            caller.db.gold -= value
            ware.move_to(caller, quiet=True)
        else:
            rtext = &quot;You cannot afford %i gold for %s!&quot; % \
                          (value, ware.key)
        caller.msg(rtext)

    options = ({&quot;desc&quot;: &quot;Buy %s for %s gold&quot; % \
                        (ware.key, ware.db.gold_value or 1),
                &quot;goto&quot;: &quot;menunode_shopfront&quot;,
                &quot;exec&quot;: buy_ware_result},
               {&quot;desc&quot;: &quot;Look for something else&quot;,
                &quot;goto&quot;: &quot;menunode_shopfront&quot;})

    return text, options
</code></pre>

<p>In this menu node we make use of the <code>raw_string</code> argument to the node. This is the text the menu user entered on the <em>previous</em> node to get here. Since we only allow numbered options in our menu, <code>raw_input</code> must be an number for the player to get to this point. So we convert it to an integer index (menu lists start from 1, whereas Python indices always starts at 0, so we need to subtract 1). We then use the index to get the corresponding item from storage.</p>
<p>We just show the customer the <code>desc</code> of the item. In a more elaborate setup you might want to show things like weapon damage and special stats here as well.</p>
<p>When the user choose the "buy" option, EvMenu will execute the <code>exec</code> instruction <em>before</em> we go back to the top node (the <code>goto</code> instruction). For this we make a little inline function <code>buy_ware_result</code>. EvMenu will call the function given to <code>exec</code> like any menu node but it does not need to return anything. In <code>buy_ware_result</code> we determine if the customer can afford the cost and give proper return messages. This is also where we actually move the bought item into the inventory of the customer.</p>
<h4 id="the-command-to-start-the-menu">The command to start the menu<a class="headerlink" href="#the-command-to-start-the-menu" title="Permanent link">&para;</a></h4>
<p>We could <em>in principle</em> launch the shopping menu the moment a customer steps into our shop room, but this would probably be considered pretty annoying. It's better to create a <a href="Commands.html">Command</a> for customers to explicitly wanting to shop around.</p>
<pre><code class="python"># mygame/typeclasses/npcshop.py

from evennia import Command

class CmdBuy(Command):
    &quot;&quot;&quot;
    Start to do some shopping

    Usage:
      buy
      shop
      browse

    This will allow you to browse the wares of the
    current shop and buy items you want.
    &quot;&quot;&quot;
    key = &quot;buy&quot;
    aliases = (&quot;shop&quot;, &quot;browse&quot;)

    def func(self):
        &quot;Starts the shop EvMenu instance&quot;
        evmenu.EvMenu(self.caller,
                      &quot;typeclasses.npcshop&quot;,
                      startnode=&quot;menunode_shopfront&quot;)
</code></pre>

<p>This will launch the menu. The <code>EvMenu</code> instance is initialized with the path to this very module - since the only global functions available in this module are our menu nodes, this will work fine (you could also have put those in a separate module). We now just need to put this command in a <a href="Command-Sets.html">CmdSet</a> so we can add it correctly to the game:</p>
<pre><code class="python">from evennia import CmdSet

class ShopCmdSet(CmdSet):
    def at_cmdset_creation(self):
        self.add(CmdBuy())
</code></pre>

<h3 id="building-the-shop">Building the shop<a class="headerlink" href="#building-the-shop" title="Permanent link">&para;</a></h3>
<p>There are really only two things that separate our shop from any other Room:</p>
<ul>
<li>The shop has the <code>storeroom</code> Attribute set on it, pointing to a second (completely normal) room.</li>
<li>It has the <code>ShopCmdSet</code> stored on itself. This makes the <code>buy</code> command available to users entering the shop.</li>
</ul>
<p>For testing we could easily add these features manually to a room using <code>@py</code> or other admin commands. Just to show how it can be done we'll instead make a custom <a href="Typeclasses.html">Typeclass</a> for the shop room and make a small command that builders can use to build both the shop and the storeroom at once.</p>
<pre><code class="python"># bottom of mygame/typeclasses/npcshop.py

from evennia import DefaultRoom, DefaultExit, DefaultObject
from evennia.utils.create import create_object

# class for our front shop room
class NPCShop(DefaultRoom):
    def at_object_creation(self):
        # we could also use add(ShopCmdSet, permanent=True)
        self.cmdset.add_default(ShopCmdSet)
        self.db.storeroom = None

# command to build a complete shop (the Command base class
# should already have been imported earlier in this file)
class CmdBuildShop(Command):
    &quot;&quot;&quot;
    Build a new shop

    Usage:
        @buildshop shopname

    This will create a new NPCshop room
    as well as a linked store room (named
    simply &lt;storename&gt;-storage) for the
    wares on sale. The store room will be
    accessed through a locked door in
    the shop.
    &quot;&quot;&quot;
    key = &quot;@buildshop&quot;
    locks = &quot;cmd:perm(Builders)&quot;
    help_category = &quot;Builders&quot;

    def func(self):
        &quot;Create the shop rooms&quot;
        if not self.args:
            self.msg(&quot;Usage: @buildshop &lt;storename&gt;&quot;)
            return
        # create the shop and storeroom
        shopname = self.args.strip()
        shop = create_object(NPCShop,
                             key=shopname,
                             location=None)
        storeroom = create_object(DefaultRoom,
                             key=&quot;%s-storage&quot; % shopname,
                             location=None)
        shop.db.storeroom = storeroom
        # create a door between the two
        shop_exit = create_object(DefaultExit,
                                  key=&quot;back door&quot;,
                                  aliases=[&quot;storage&quot;, &quot;store room&quot;],
                                  location=shop,
                                  destination=storeroom)
        storeroom_exit = create_object(DefaultExit,
                                  key=&quot;door&quot;,
                                  location=storeroom,
                                  destination=shop)
        # make a key for accessing the store room
        storeroom_key_name = &quot;%s-storekey&quot; % shopname
        storeroom_key = create_object(DefaultObject,
                                       key=storeroom_key_name,
                                       location=shop)
        # only allow chars with this key to enter the store room
        shop_exit.locks.add(&quot;traverse:holds(%s)&quot; % storeroom_key_name)

        # inform the builder about progress
        self.caller.msg(&quot;The shop %s was created!&quot; % shop)
</code></pre>

<p>Our typeclass is simple and so is our <code>buildshop</code> command. The command (which is for Builders only) just takes the name of the shop and builds the front room and a store room to go with it (always named <code>"&lt;shopname&gt;-storage"</code>. It connects the rooms with a two-way exit. You need to add <code>CmdBuildShop</code> <a href="Adding-Command-Tutorial#step-2-adding-the-command-to-a-default-cmdset">to the default cmdset</a> before you can use it. Once having created the shop you can now <code>@teleport</code> to it or <code>@open</code> a new exit to it. You could also easily expand the above command to automatically create exits to and from the new shop from your current location.</p>
<p>To avoid customers walking in and stealing everything, we create a <a href="Locks.html">Lock</a> on the storage door. It's a simple lock that requires the one entering to carry an object named <code>&lt;shopname&gt;-storekey</code>. We even create such a key object and drop it in the shop for the new shop keeper to pick up.</p>
<blockquote>
<p>If players are given the right to name their own objects, this simple lock is not very secure and you need to come up with a more robust lock-key solution.</p>
<p>We don't add any descriptions to all these objects so looking "at" them will not be too thrilling. You could add better default descriptions as part of the <code>@buildshop</code> command or leave descriptions this up to the Builder.</p>
</blockquote>
<h3 id="the-shop-is-open-for-business">The shop is open for business!<a class="headerlink" href="#the-shop-is-open-for-business" title="Permanent link">&para;</a></h3>
<p>We now have a functioning shop and an easy way for Builders to create it. All you need now is to <code>@open</code> a new exit from the rest of the game into the shop and put some sell-able items in the store room. Our shop does have some shortcomings:</p>
<ul>
<li>For Characters to be able to buy stuff they need to also have the <code>gold</code> Attribute set on themselves.</li>
<li>We manually remove the "door" exit from our items for sale. But what if there are other unsellable items in the store room? What if the shop owner walks in there for example - anyone in the store could then buy them for 1 gold.</li>
<li>What if someone else were to buy the item we're looking at just before we decide to buy it? It would then be gone and the counter be wrong - the shop would pass us the next item in the list.</li>
</ul>
<p>Fixing these issues are left as an exercise.</p>
<p>If you want to keep the shop fully NPC-run you could add a <a href="Scripts.html">Script</a> to restock the shop's store room regularly. This shop example could also easily be owned by a human Player (run for them by a hired NPC) - the shop owner would get the key to the store room and be responsible for keeping it well stocked.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

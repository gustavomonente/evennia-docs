<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>New Models - Evennia Manual</title>
        <link href="css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">Evennia Manual</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="index.html">Home</a>
                            </li>
                            <li >
                                <a href="Administrative-Docs.html">Admin</a>
                            </li>
                            <li >
                                <a href="Builder-Docs.html">Building</a>
                            </li>
                            <li >
                                <a href="Developer-Central.html">Game Development</a>
                            </li>
                            <li >
                                <a href="Tutorials.html">Tutorials</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#overview-of-database-tables">Overview of database tables</a></li>
        <li class="main "><a href="#adding-a-new-database-table">Adding a new database table</a></li>
        <li class="main "><a href="#defining-your-models">Defining your models</a></li>
        <li class="main "><a href="#creating-a-new-model-instance">Creating a new model instance</a></li>
        <li class="main "><a href="#using-the-sharedmemorymodel-parent">Using the SharedMemoryModel parent</a></li>
        <li class="main "><a href="#searching-for-your-models">Searching for your models</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><em>Note: This is considered an advanced topic.</em></p>
<p>Evennia offers many convenient ways to store object data, such as via Attributes or Scripts. This is sufficient for most use cases. But if you aim to build a large stand-alone system, trying to squeeze your storage requirements into those may be more complex than you bargain for. Examples may be to store guild data for guild members to be able to change, tracking the flow of money across a game-wide economic system or implement other custom game systems that requires the storage of custom data in a quickly accessible way. Whereas <a href="Tags.html">Tags</a> or <a href="Scripts.html">Scripts</a> can handle many situations, sometimes things may be easier to handle by adding your own database model.</p>
<h2 id="overview-of-database-tables">Overview of database tables<a class="headerlink" href="#overview-of-database-tables" title="Permanent link">&para;</a></h2>
<p>SQL-type databases (which is what Evennia supports) are basically highly optimized systems for retrieving text stored in tables. A table may look like this</p>
<pre><code>     id | db_key    | db_typeclass_path          | db_permissions  ...
    ------------------------------------------------------------------
     1  |  Griatch  | evennia.DefaultCharacter   | Developers       ...
     2  |  Rock     | evennia.DefaultObject      | None            ...
</code></pre>

<p>Each line is considerably longer in your database. Each column is referred to as a "field" and every row is a separate object. You can check this out for yourself. If you use the default sqlite3 database, go to your game folder and run</p>
<pre><code> evennia dbshell
</code></pre>
<p>You will drop into the database shell. While there, try:</p>
<pre><code> sqlite&gt; .help       # view help

 sqlite&gt; .tables     # view all tables

 # show the table field names for objects_objectdb
 sqlite&gt; .schema objects_objectdb

 # show the first row from the objects_objectdb table
 sqlite&gt; select * from objects_objectdb limit 1;

 sqlite&gt; .exit
</code></pre>
<p>Evennia uses <a href="https://docs.djangoproject.com">Django</a>, which abstracts away the database SQL manipulation and allows you to search and manipulate your database entirely in Python. Each database table is in Django represented by a class commonly called a <em>model</em> since it describes the look of the table. In Evennia, Objects, Scripts, Channels etc are examples of Django models that we then extend and build on.</p>
<h2 id="adding-a-new-database-table">Adding a new database table<a class="headerlink" href="#adding-a-new-database-table" title="Permanent link">&para;</a></h2>
<p>Here is how you add your own database table/models:</p>
<ol>
<li>
<p>In Django lingo, we will create a new "application" - a subsystem under the main Evennia program. For this example we'll call it "myapp". Run the following (you need to have a working Evennia running before you do this, so make sure you have run the steps in <a href="Getting-Started">Getting Started</a> first):</p>
<pre><code>cd mygame/world
evennia startapp myapp
</code></pre>
</li>
<li>
<p>A new folder <code>myapp</code> is created. "myapp" will also be the name (the "app label") from now on. We chose to put it in the <code>world/</code> subfolder here, but you could put it in the root of your <code>mygame</code> if that makes more sense.</p>
</li>
<li>The <code>myapp</code> folder contains a few empty default files. What we are
interested in for now is <code>models.py</code>. In <code>models.py</code> you define your model(s). Each model will be a table in the database. See the next section and don't continue until you have added the models you want.</li>
<li>
<p>You now need to tell Evennia that the models of your app should be a part of your database scheme. Add this line to your <code>mygame/server/conf/settings.py</code>file (make sure to use the path where you put <code>myapp</code> and don't forget the comma at the end of the tuple):</p>
<p><code>INSTALLED_APPS = INSTALLED_APPS + ("world.myapp", )</code></p>
</li>
<li>
<p>From <code>mygame/</code>, run</p>
<pre><code>evennia makemigrations myapp
evennia migrate
</code></pre>
</li>
</ol>
<p>This will add your new database table to the database. If you have put your game under version control (if not, <a href="Version-Control">you should</a>), don't forget to <code>git add myapp/*</code> to add all items to version control.</p>
<h2 id="defining-your-models">Defining your models<a class="headerlink" href="#defining-your-models" title="Permanent link">&para;</a></h2>
<p>A Django <em>model</em> is the Python representation of a database table. It can be handled like any other Python class. It defines <em>fields</em> on itself, objects of a special type. These become the "columns" of the database table. Finally, you create new instances of the model to add new rows to the database.</p>
<p>We won't describe all aspects of Django models here, for that we refer to the vast <a href="https://docs.djangoproject.com/en/1.7/topics/db/models/">Django documentation</a> on the subject. Here is a (very) brief example:</p>
<pre><code class="python">from django.db import models

class MyDataStore(models.Model):
    &quot;A simple model for storing some data&quot;
    db_key = models.CharField(max_length=80, db_index=True)
    db_category = models.CharField(max_length=80, null=True, blank=True)
    db_text = models.TextField(null=True, blank=True)
    # we need this one if we want to be
    # able to store this in an Evennia Attribute!
    db_date_created = models.DateTimeField('date created', editable=False,
                                            auto_now_add=True, db_index=True)
</code></pre>

<p>We create four fields: two character fields of limited length and one text field which has no maximum length. Finally we create a field containing the current time of us creating this object.</p>
<blockquote>
<p>The <code>db_date_created</code> field, with exactly this name, is <em>required</em> if you want to be able to store instances of your custom model in an Evennia <a href="Attributes.html">Attribute</a>. It will automatically be set upon creation and can after that not be changed. Having this field will allow you to do e.g. <code>obj.db.myinstance = mydatastore</code>. If you know you'll never store your model instances in Attributes the <code>db_date_created</code> field is optional.</p>
</blockquote>
<p>You don't <em>have</em> to start field names with <code>db_</code>, this is an Evennia convention. It's nevertheless recommended that you do use <code>db_</code>, partly for clarity and consistency with Evennia (if you ever want to share your code) and partly for the case of you later deciding to use Evennia's <code>SharedMemoryModel</code> parent down the line.</p>
<p>The field keyword <code>db_index</code> creates a <em>database index</em> for this field, which allows quicker lookups, so it's recommended to put it on fields you know you'll often use in queries. The <code>null=True</code> and <code>blank=True</code> keywords means that these fields may be left empty or set to the empty string without the database complaining. There are many other field types and keywords to define them, see django docs for more info.</p>
<p>Similar to using <a href="https://docs.djangoproject.com/en/1.8/howto/legacy-databases/">django-admin</a> you are able to do <code>evennia inspectdb</code> to get an automated listing of model information for an existing database.  As is the case with any model generating tool you should only use this as a starting point for your models.</p>
<h2 id="creating-a-new-model-instance">Creating a new model instance<a class="headerlink" href="#creating-a-new-model-instance" title="Permanent link">&para;</a></h2>
<p>To create a new row in your table, you instantiate the model and then call its <code>save()</code> method:</p>
<pre><code class="python">     from evennia.myapp import MyDataStore

     new_datastore = MyDataStore(db_key=&quot;LargeSword&quot;,
                                 db_category=&quot;weapons&quot;,
                                 db_text=&quot;This is a huge weapon!&quot;)
     # this is required to actually create the row in the database!
     new_datastore.save()

</code></pre>

<p>Note that the <code>db_date_created</code> field of the model is not specified. Its flag <code>at_now_add=True</code> makes sure to set it to the current date when the object is created (it can also not be changed further after creation).</p>
<p>When you update an existing object with some new field value, remember that you have to save the object afterwards, otherwise the database will not update:</p>
<pre><code class="python">    my_datastore.db_key = &quot;Larger Sword&quot;
    my_datastore.save()
</code></pre>

<p>Evennia's normal models don't need to explicitly save, since they are based on <code>SharedMemoryModel</code> rather than the raw django model. This is covered in the next section.</p>
<h2 id="using-the-sharedmemorymodel-parent">Using the <code>SharedMemoryModel</code> parent<a class="headerlink" href="#using-the-sharedmemorymodel-parent" title="Permanent link">&para;</a></h2>
<p>Evennia doesn't base most of its models on the raw <code>django.db.models</code> but on the Evennia base model <code>evennia.utils.idmapper.models.SharedMemoryModel</code>. There are two main reasons for this:</p>
<ol>
<li>Ease of updating fields without having to explicitly call <code>save()</code></li>
<li>On-object memory persistence and database caching</li>
</ol>
<p>The first (and least important) point means that as long as you named your fields <code>db_*</code>, Evennia will automatically create field wrappers for them. This happens in the model's <a href="http://en.wikibooks.org/wiki/Python_Programming/Metaclasses">Metaclass</a> so there is no speed penalty for this. The name of the wrapper will be the same name as the field, minus the <code>db_</code> prefix. So the <code>db_key</code> field will have a wrapper property named <code>key</code>. You can then do:</p>
<pre><code class="python">    my_datastore.key = &quot;Larger Sword&quot;
</code></pre>

<p>and don't have to explicitly call <code>save()</code> afterwards. The saving also happens in a more efficient way under the hood, updating only the field rather than the entire model using django optimizations. Note that if you were to manually add the property or method <code>key</code> to your model, this will be used instead of the automatic wrapper and allows you to fully customize access as needed.</p>
<p>To explain the second and more important point, consider the following example using the default Django model parent:</p>
<pre><code class="python">    shield = MyDataStore.objects.get(db_key=&quot;SmallShield&quot;)
    shield.cracked = True # where cracked is not a database field
</code></pre>

<p>And then later:</p>
<pre><code class="python">    shield = MyDataStore.objects.get(db_key=&quot;SmallShield&quot;)
    print(shield.cracked)  # error!
</code></pre>

<p>The outcome of that last print statement is <em>undefined</em>! It could <em>maybe</em> randomly work but most likely you will get an <code>AttributeError</code> for not finding the <code>cracked</code> property. The reason is that <code>cracked</code> doesn't represent an actual field in the database. It was just added at run-time and thus Django don't care about it. When you retrieve your shield-match later there is <em>no</em> guarantee you will get back the <em>same Python instance</em> of the model where you defined <code>cracked</code>, even if you search for the same database object.</p>
<p>Evennia relies heavily on on-model handlers and other dynamically created properties. So rather than using the vanilla Django models, Evennia uses <code>SharedMemoryModel</code>, which levies something called <em>idmapper</em>. The idmapper caches model instances so that we will always get the <em>same</em> instance back after the first lookup of a given object. Using idmapper, the above example would work fine and you could retrieve your <code>cracked</code> property at any time - until you rebooted when all non-persistent data goes.</p>
<p>Using the idmapper is both more intuitive and more efficient <em>per object</em>; it leads to a lot less reading from disk. The drawback is that this system tends to be more memory hungry <em>overall</em>. So if you know that you'll <em>never</em> need to add new properties to running instances or know that you will create new objects all the time yet rarely access them again (like for a log system), you are probably better off making "plain" Django models rather than using <code>SharedMemoryModel</code> and its idmapper.</p>
<p>To use the idmapper and the field-wrapper functionality you just have to have your model classes inherit from <code>evennia.utils.idmapper.models.SharedMemoryModel</code> instead of from the default <code>django.db.models.Model</code>:</p>
<pre><code class="python">from evennia.utils.idmapper.models import SharedMemoryModel

class MyDataStore(SharedMemoryModel):
    # the rest is the same as before, but db_* is important; these will
    # later be settable as .key, .category, .text ...
    db_key = models.CharField(max_length=80, db_index=True)
    db_category = models.CharField(max_length=80, null=True, blank=True)
    db_text = models.TextField(null=True, blank=True)
    db_date_created = models.DateTimeField('date created', editable=False,
                                            auto_now_add=True, db_index=True)
</code></pre>

<h2 id="searching-for-your-models">Searching for your models<a class="headerlink" href="#searching-for-your-models" title="Permanent link">&para;</a></h2>
<p>To search your new custom database table you need to use its database <em>manager</em> to build a <em>query</em>.  Note that even if you use <code>SharedMemoryModel</code> as described in the previous section, you have to use the actual <em>field names</em> in the query, not the wrapper name (so <code>db_key</code> and not just <code>key</code>).</p>
<pre><code class="python">     from world.myapp import MyDataStore

     # get all datastore objects exactly matching a given key
     matches = MyDataStore.objects.filter(db_key=&quot;Larger Sword&quot;)
     # get all datastore objects with a key containing &quot;sword&quot;
     # and having the category &quot;weapons&quot; (both ignoring upper/lower case)
     matches2 = MyDataStore.objects.filter(db_key__icontains=&quot;sword&quot;,
                                           db_category__iequals=&quot;weapons&quot;)
     # show the matching data (e.g. inside a command)
     for match in matches2:
        self.caller.msg(match.db_text)
</code></pre>

<p>See the <a href="https://docs.djangoproject.com/en/1.9/topics/db/queries/">Django query documentation</a> for a lot more information about querying the database.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

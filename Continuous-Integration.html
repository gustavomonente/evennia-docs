<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="./img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Continuous Integration - Evennia Manual</title>
    <link href="./css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="./css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="./css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/bootstrap-3.3.7.min.js"></script>
    <script src="./js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '.';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "What is Continuous Integration?", url: "#_top", children: [
          ]},
          {title: "Preparation", url: "#preparation", children: [
          ]},
          {title: "Linux TeamCity Setup", url: "#linux-teamcity-setup", children: [
              {title: "A Quick Overview", url: "#a-quick-overview" },
              {title: "Template Setup", url: "#template-setup" },
          ]},
          {title: "!/bin/bash", url: "#binbash", children: [
          ]},
          {title: "Replaces the game configuration with one", url: "#replaces-the-game-configuration-with-one", children: [
          ]},
          {title: "appropriate for this deployment.", url: "#appropriate-for-this-deployment", children: [
          ]},
          {title: "settings.py MySQL DB configuration", url: "#settingspy-mysql-db-configuration", children: [
          ]},
          {title: "Create the My.CNF file.", url: "#create-the-mycnf-file", children: [
          ]},
          {title: "!/bin/bash", url: "#binbash_1", children: [
          ]},
          {title: "Update the DB migration", url: "#update-the-db-migration", children: [
          ]},
          {title: "Check that the logs directory exists.", url: "#check-that-the-logs-directory-exists", children: [
          ]},
          {title: "Check that the logs directory exists.", url: "#check-that-the-logs-directory-exists_1", children: [
          ]},
          {title: "Copy all the files.", url: "#copy-all-the-files", children: [
          ]},
          {title: "Check that the logs directory exists.", url: "#check-that-the-logs-directory-exists_2", children: [
          ]},
          {title: "Check that the server is running.", url: "#check-that-the-server-is-running", children: [
              {title: "Creating the Project", url: "#creating-the-project" },
          ]},
        ];

    </script>
    <script src="./js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <p>One of the advantages of Evennia over traditional MUSH development systems is that Evennia is
capable of integrating into enterprise level integration environments and source control. Because of
this, it can also be the subject of automation for additional convenience, allowing a more
streamlined development environment.</p>
<h2 id="what-is-continuous-integration">What is Continuous Integration?<a class="headerlink" href="#what-is-continuous-integration" title="Permanent link">&para;</a></h2>
<p><a href="https://www.thoughtworks.com/continuous-integration">Continuous Integration (CI)</a> is a development
practice that requires developers to integrate code into a shared repository several times a day.
Each check-in is then verified by an automated build, allowing teams to detect problems early.</p>
<p>For Evennia, continuous integration allows an automated build process to:
* Pull down a latest build from Source Control.
* Run migrations on the backing SQL database.
* Automate additional unique tasks for that project.
* Run unit tests.
* Publish those files to the server directory
* Reload the game.</p>
<h2 id="preparation">Preparation<a class="headerlink" href="#preparation" title="Permanent link">&para;</a></h2>
<p>To prepare a CI environment for your <code>MU*</code>, it will be necessary to set up some prerequisite software for your server.</p>
<p>Among those you will need:
* A Continuous Integration Environment.
  * I recommend <a href="https://www.jetbrains.com/teamcity/">TeamCity</a> which has an in-depth <a href="https://confluence.jetbrains.com/display/TCD8/Installing+and+Configuring+the+TeamCity+Server">Setup Guide</a>
* <a href="https://github.com/evennia/evennia/wiki/Version%20Control">Source Control</a>
  * This could be Git or SVN or any other available SC.</p>
<h2 id="linux-teamcity-setup">Linux TeamCity Setup<a class="headerlink" href="#linux-teamcity-setup" title="Permanent link">&para;</a></h2>
<p>For this part of the guide, an example setup will be provided for administrators running a TeamCity
build integration environment on Linux. </p>
<p>After meeting the preparation steps for your specific environment, log on to your teamcity interface
at <code>http://&lt;your server&gt;:8111/</code>.</p>
<p>Create a new project named "Evennia" and in it construct a new template called continuous-integration.</p>
<h3 id="a-quick-overview">A Quick Overview<a class="headerlink" href="#a-quick-overview" title="Permanent link">&para;</a></h3>
<p>Templates are fancy objects in TeamCity that allow an administrator to define build steps that are
shared between one or more build projects. Assigning a VCS Root (Source Control) is unnecessary at
this stage, primarily you'll be worrying about the build steps and your default parameters (both
visible on the tabs to the left.)</p>
<h3 id="template-setup">Template Setup<a class="headerlink" href="#template-setup" title="Permanent link">&para;</a></h3>
<p>In this template, you'll be outlining the steps necessary to build your specific game. (A number of
sample scripts are provided under this section below!) Click Build Steps and prepare your general
flow. For this example, we will be doing a few basic example steps:</p>
<ul>
<li>Transforming the Settings.py file</li>
<li>We do this to update ports or other information that make your production environment unique
    from your development environment.</li>
<li>Making migrations and migrating the game database.</li>
<li>Publishing the game files.</li>
<li>Reloading the server.</li>
</ul>
<p>For each step we'll being use the "Command Line Runner" (a fancy name for a shell script executor).</p>
<ul>
<li>Create a build step with the name: Transform Configuration</li>
<li>
<p>For the script add:    </p>
<p>```bash</p>
<h1 id="binbash">!/bin/bash<a class="headerlink" href="#binbash" title="Permanent link">&para;</a></h1>
<h1 id="replaces-the-game-configuration-with-one">Replaces the game configuration with one<a class="headerlink" href="#replaces-the-game-configuration-with-one" title="Permanent link">&para;</a></h1>
<h1 id="appropriate-for-this-deployment">appropriate for this deployment.<a class="headerlink" href="#appropriate-for-this-deployment" title="Permanent link">&para;</a></h1>
<p>CONFIG="%system.teamcity.build.checkoutDir%/server/conf/settings.py"
MYCONF="%system.teamcity.build.checkoutDir%/server/conf/my.cnf"</p>
<p>sed -e 's/TELNET_PORTS = [4000]/TELNET_PORTS = [%game.ports%]/g' "$CONFIG" &gt; "$CONFIG".tmp &amp;&amp; mv "$CONFIG".tmp "$CONFIG"
sed -e 's/WEBSERVER_PORTS = [(4001, 4002)]/WEBSERVER_PORTS = [%game.webports%]/g' "$CONFIG" &gt; "$CONFIG".tmp &amp;&amp; mv "$CONFIG".tmp "$CONFIG"</p>
<h1 id="settingspy-mysql-db-configuration">settings.py MySQL DB configuration<a class="headerlink" href="#settingspy-mysql-db-configuration" title="Permanent link">&para;</a></h1>
<p>echo Configuring Game Database...
echo "" &gt;&gt; "$CONFIG"
echo "######################################################################" &gt;&gt; "$CONFIG"
echo "# MySQL Database Configuration" &gt;&gt; "$CONFIG"
echo "######################################################################" &gt;&gt; "$CONFIG"</p>
<p>echo "DATABASES = {" &gt;&gt; "$CONFIG"
echo "   'default': {" &gt;&gt; "$CONFIG"
echo "       'ENGINE': 'django.db.backends.mysql'," &gt;&gt; "$CONFIG"
echo "       'OPTIONS': {" &gt;&gt; "$CONFIG"
echo "           'read_default_file': 'server/conf/my.cnf'," &gt;&gt; "$CONFIG"
echo "       }," &gt;&gt; "$CONFIG"
echo "   }" &gt;&gt; "$CONFIG"
echo "}" &gt;&gt; "$CONFIG"</p>
<h1 id="create-the-mycnf-file">Create the My.CNF file.<a class="headerlink" href="#create-the-mycnf-file" title="Permanent link">&para;</a></h1>
<p>echo "[client]" &gt;&gt; "$MYCONF"
echo "database = %mysql.db%" &gt;&gt; "$MYCONF"
echo "user = %mysql.user%" &gt;&gt; "$MYCONF"
echo "password = %mysql.pass%" &gt;&gt; "$MYCONF"
echo "default-character-set = utf8" &gt;&gt; "$MYCONF"
```</p>
</li>
</ul>
<p>If you look at the parameters side of the page after saving this script, you'll notice that some new
parameters have been populated for you. This is because we've included new teamcity configuration
parameters that are populated when the build itself is ran. When creating projects that inherit this
template, we'll be able to fill in or override those parameters for project-specific configuration.</p>
<ul>
<li>Go ahead and create another build step called "Make Database Migration"</li>
<li>If you're using SQLLite on your game, it will be prudent to change working directory on this step to: %game.dir%</li>
<li>
<p>In this script include:</p>
<p>```bash</p>
<h1 id="binbash_1">!/bin/bash<a class="headerlink" href="#binbash_1" title="Permanent link">&para;</a></h1>
<h1 id="update-the-db-migration">Update the DB migration<a class="headerlink" href="#update-the-db-migration" title="Permanent link">&para;</a></h1>
<p>LOGDIR="server/logs"</p>
<p>. %evenv.dir%/bin/activate</p>
<h1 id="check-that-the-logs-directory-exists">Check that the logs directory exists.<a class="headerlink" href="#check-that-the-logs-directory-exists" title="Permanent link">&para;</a></h1>
<p>if [ ! -d "$LOGDIR" ]; then
  # Control will enter here if $LOGDIR doesn't exist.
  mkdir "$LOGDIR"
fi</p>
<p>evennia makemigrations
```</p>
</li>
<li>
<p>Create yet another build step, this time named: "Execute Database Migration":</p>
</li>
<li>
<p>If you're using SQLLite on your game, it will be prudent to change working directory on this step to: %game.dir%
    ```bash
    #!/bin/bash
    # Apply the database migration.</p>
<p>LOGDIR="server/logs"</p>
<p>. %evenv.dir%/bin/activate</p>
<h1 id="check-that-the-logs-directory-exists_1">Check that the logs directory exists.<a class="headerlink" href="#check-that-the-logs-directory-exists_1" title="Permanent link">&para;</a></h1>
<p>if [ ! -d "$LOGDIR" ]; then
  # Control will enter here if $LOGDIR doesn't exist.
  mkdir "$LOGDIR"
fi</p>
<p>evennia migrate</p>
<p>```</p>
</li>
</ul>
<p>Our next build step is where we actually publish our build. Up until now, all work on game has been
done in a 'work' directory on TeamCity's build agent. From that directory we will now copy our files
to where our game actually exists on the local server.</p>
<ul>
<li>Create a new build step called "Publish Build":</li>
<li>
<p>If you're using SQLLite on your game, be sure to order this step ABOVE the Database Migration steps. The build order will matter!
    ```bash
    #!/bin/bash
    # Publishes the build to the proper build directory.</p>
<p>DIRECTORY="%game.dir%"</p>
<p>if [ ! -d "$DIRECTORY" ]; then
  # Control will enter here if $DIRECTORY doesn't exist.
  mkdir "$DIRECTORY"
fi</p>
<h1 id="copy-all-the-files">Copy all the files.<a class="headerlink" href="#copy-all-the-files" title="Permanent link">&para;</a></h1>
<p>cp -ruv %teamcity.build.checkoutDir%/* "$DIRECTORY"
chmod -R 775 "$DIRECTORY"</p>
<p>```</p>
</li>
</ul>
<p>Finally the last script will reload our game for us.</p>
<ul>
<li>Create a new script called "Reload Game":</li>
<li>
<p>The working directory on this build step will be: %game.dir%
    ```bash
    #!/bin/bash
    # Apply the database migration.</p>
<p>LOGDIR="server/logs"
PIDDIR="server/server.pid"</p>
<p>. %evenv.dir%/bin/activate</p>
<h1 id="check-that-the-logs-directory-exists_2">Check that the logs directory exists.<a class="headerlink" href="#check-that-the-logs-directory-exists_2" title="Permanent link">&para;</a></h1>
<p>if [ ! -d "$LOGDIR" ]; then
  # Control will enter here if $LOGDIR doesn't exist.
  mkdir "$LOGDIR"
fi</p>
<h1 id="check-that-the-server-is-running">Check that the server is running.<a class="headerlink" href="#check-that-the-server-is-running" title="Permanent link">&para;</a></h1>
<p>if [ -d "$PIDDIR" ]; then
  # Control will enter here if the game is running.
  evennia reload
fi
```</p>
</li>
</ul>
<p>Now the template is ready for use! It would be useful this time to revisit the parameters page and
set the evenv parameter to the directory where your virtualenv exists: IE "/srv/mush/evenv".</p>
<h3 id="creating-the-project">Creating the Project<a class="headerlink" href="#creating-the-project" title="Permanent link">&para;</a></h3>
<p>Now it's time for the last few steps to set up a CI environment.</p>
<ul>
<li>Return to the Evennia Project overview/administration page. </li>
<li>Create a new Sub-Project called "Production"</li>
<li>This will be the category that holds our actual game.</li>
<li>Create a new Build Configuration in Production with the name of your MUSH.</li>
<li>Base this configuration off of the continuous-integration template we made earlier.</li>
<li>In the build configuration, enter VCS roots and create a new VCS root that points to the branch/version control that you are using.</li>
<li>Go to the parameters page and fill in the undefined parameters for your specific configuration.</li>
<li>If you wish for the CI to run every time a commit is made, go to the VCS triggers and add one for "On Every Commit".</li>
</ul>
<p>And you're done! At this point, you can return to the project overview page and queue a new build
for your game. If everything was set up correctly, the build will complete successfully. Additional
build steps could be added or removed at this point, adding some features like Unit Testing or more!</p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>